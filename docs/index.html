<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Fritsch Group - Chemical Inventory System</title>

	<link rel="manifest" href="manifest.json">
	<link rel="apple-touch-icon" href="flask-icon-192.png">
	<meta name="apple-mobile-web-app-capable" content="yes">
	<meta name="apple-mobile-web-app-status-bar-style" content="default">
	<meta name="apple-mobile-web-app-title" content="Chemical Inventories">
	<meta name="theme-color" content="#333333">

	<!-- Barcode Scanner -->
	<script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>

	<!-- Excel Reader -->
	<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

	<!-- jsPDF & JsBarcode -->
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
</head>
<body>
	<header class="page-title">
		<h1>Fritsch Group Chemical Inventory</h1>
	</header>

	<div id="login-section" class="login-container">
		<h2>Login</h2>
		<input type="text" id="username" placeholder="Name:" />
		<button onclick="loginUser()">Login</button>
	</div>

	<div id="home-section" class="home-container" style="display: none;">
		<h2>Hello, <span id="display-name"></span>! What would you like to do?</h2>
		<div class="actions-container">
			<button onclick="searchChemicals()">üîç Search Chemicals</button>
			<button onclick="startAudit()">üì¶ Inventory Audit</button>
		</div>

		<div style="margin-top: 40px;">
			<h3>Upload Chemical Inventory Excel</h3>
			<input type="file" id="excel-file" accept=".xlsx, .xls, .csv" onchange="handleFileUpload(event)" />
			<button onclick="downloadModifiedFile()" style="margin-top: 30px;">üíæ Download File with Barcodes</button>
			<button onclick="generateLabels()" style="margin-top: 30px;">üè∑Ô∏è Generate Labels</button>
			<div id="excel-preview" style="margin-top: 20px;"></div>
		</div>
	</div>

	<div id="audit-section" style="display: none; margin-top: 30px;">
		<h3>Inventory Audit</h3>
		<button onclick="InvexitSearch()" style="margin-bottom: 30px;">üîô Back to Menu</button>
		<button onclick="scanAuditBarcode()">üì∑ Scan Chemical</button>
		<ul id="audit-results" style="margin-top: 30px;"></ul>
		<button onclick="downloadAuditLog()" style="margin-top: 30px;">üíæ Download Audit Log</button>
	</div>

	<div class="search-chemicals" id="search-chemicals" style="display: none; margin-top: 30px;">
		<h3>Search Chemicals</h3>
		<button onclick="exitSearch()" style="margin-bottom: 30px;">üîô Back to Menu</button>
		<div style="display: flex; flex-wrap: wrap; gap: 30px; margin-bottom: 30px;">
			<input type="text" id="search-input" placeholder="Search by name or CAS" oninput="performSearch()" style="flex: 1; min-width: 100px;" />
			<button type="button" onclick="clearSearch()">‚ùå Clear</button>
		</div>
		<button onclick="scanBarcode()">üì∑ Scan Barcode</button>
		<ul id="search-results"></ul>
	</div>

	<!-- Hidden barcode container -->
	<div style="display: none;">
		<svg id="barcode-preview"></svg>
	</div>

	<script>
		window.jsPDF = window.jspdf.jsPDF;

		function wrapText(doc, text, maxWidth, maxCharsPerLine = 30) {
			const words = text.split(" ");
			const lines = [];
			let currentLine = "";

			for (let i = 0; i < words.length; i++) {
				let word = words[i].trim();
				let testLine = currentLine ? currentLine + " " + word : word;

				if (doc.getTextWidth(testLine) < maxWidth && testLine.length <= maxCharsPerLine) {
					currentLine = testLine;
				} else {
					if (currentLine) lines.push(currentLine);
					while (word.length > 0) {
						let cutoff = Math.min(word.length, maxCharsPerLine);
						while (cutoff > 0 && (doc.getTextWidth(word.slice(0, cutoff)) > maxWidth)) {
							cutoff--;
						}
						if (cutoff === 0) break;
						lines.push(word.slice(0, cutoff));
						word = word.slice(cutoff);
					}
					currentLine = word;
				}
			}
			if (currentLine) lines.push(currentLine);
			return lines;
		}

		async function generateLabels() {
			const selectedIndexes = Array.from(document.querySelectorAll('.label-checkbox'))
				.filter(cb => cb.checked)
				.map(cb => parseInt(cb.dataset.index));

			const labelData = selectedIndexes.map(i => workingData[i]);

			if (labelData.length === 0) {
				alert("Please select at least one chemical to generate labels.");
				return;
			}

			const doc = new jsPDF({ unit: "mm", format: "letter" });
			doc.setFont("helvetica", "normal");

			const labelsPerRow = 3;
			const labelsPerColumn = 10;
			const labelWidth = 66.675;
			const labelHeight = 25.4;
			const marginX = 3.8;
			const marginY = 12.3;
			const spacingX = 4.175;
			const spacingY = 0.2;

			for (let i = 0; i < labelData.length; i++) {
				const item = labelData[i];

				const row = Math.floor((i % 30) / labelsPerRow);
				const col = i % labelsPerRow;
				const x = marginX + col * (labelWidth + spacingX);
				const y = marginY + row * (labelHeight + spacingY);

				// Barcode generation
				const barcodeSvg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
				JsBarcode(barcodeSvg, item["Barcode"], {
					format: "CODE128",
					displayValue: false,
					height: 10,
					width: 1.5,
					margin: 0
				});

				const barcodeCanvas = document.createElement("canvas");
				const svgData = new XMLSerializer().serializeToString(barcodeSvg);
				const svgBlob = new Blob([svgData], { type: "image/svg+xml;charset=utf-8" });
				const url = URL.createObjectURL(svgBlob);

				const img = new Image();
				await new Promise(resolve => {
					img.onload = function () {
						const ctx = barcodeCanvas.getContext("2d");
						barcodeCanvas.width = img.width;
						barcodeCanvas.height = img.height;
						ctx.drawImage(img, 0, 0);
						URL.revokeObjectURL(url);
						resolve();
					};
					img.src = url;
				});

				const barcodeDataUrl = barcodeCanvas.toDataURL("image/png");

				// Layout
				const nameTop = y + 4;
				const nameLineHeight = 4;
				const infoSpacing = 1.5;
				const barcodeSpacing = 2;
				const barcodeWidth = 40;
				const barcodeHeight = 5;
				const maxNameLines = 2;

				// Chemical Name
				let fontSize = 9;
				doc.setFontSize(fontSize);
				let nameLines = wrapText(doc, item["Chemical Name"], labelWidth);
				while (nameLines.length > maxNameLines && fontSize > 6) {
					fontSize -= 0.5;
					doc.setFontSize(fontSize);
					nameLines = wrapText(doc, item["Chemical Name"], labelWidth);
				}
				nameLines = nameLines.slice(0, maxNameLines);
				nameLines.forEach((line, idx) => {
					const yOffset = nameTop + idx * nameLineHeight;
					const xOffset = x + (labelWidth - doc.getTextWidth(line)) / 2;
					doc.text(line, xOffset, yOffset);
				});

				// CAS number
				const cas = item["CAS Number"] || "N/A";
				const infoLine = `CAS: ${cas}`;
				const infoYOffset = nameTop + nameLines.length * nameLineHeight + infoSpacing;
				doc.setFontSize(7);
				const casTextWidth = doc.getTextWidth(infoLine);
				doc.text(infoLine, x + (labelWidth - casTextWidth) / 2, infoYOffset);

				// Barcode image
				const barcodeYOffset = infoYOffset + barcodeSpacing;
				const maxBarcodeYOffset = y + labelHeight - barcodeHeight - 4;
				const finalBarcodeYOffset = Math.min(barcodeYOffset, maxBarcodeYOffset);
				doc.addImage(barcodeDataUrl, "PNG", x + (labelWidth - barcodeWidth) / 2, finalBarcodeYOffset, barcodeWidth, barcodeHeight);

				// Barcode text
				const barcodeText = item["Barcode"];
				const barcodeTextYOffset = finalBarcodeYOffset + barcodeHeight + 3;
				doc.setFontSize(8);
				const barcodeTextWidth = doc.getTextWidth(barcodeText);
				doc.text(barcodeText, x + (labelWidth - barcodeTextWidth) / 2, barcodeTextYOffset);

				// Optional: draw label border for debugging
				// doc.setDrawColor(200);
				// doc.rect(x, y, labelWidth, labelHeight);

				if ((i + 1) % 30 === 0 && i + 1 < labelData.length) {
					doc.addPage();
				}
			}

			const today = new Date().toISOString().slice(0, 10);
			doc.save(`Chemical_Labels_${today}.pdf`);
		}
	</script>
</body>
</html>
