<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Fritsch Group - Chemical Inventory System</title>

  <!-- Web App Metadata -->
  <link rel="manifest" href="manifest.json" />
  <link rel="apple-touch-icon" href="flask-icon-192.png" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="theme-color" content="#333333" />
  <meta name="apple-mobile-web-app-title" content="Chemical Inventories" />

  <!-- Fonts & Libraries -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link
    href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap"
    rel="stylesheet"
  />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <!-- Roboto Embedded Font for jsPDF -->
  <script>
    window.jsPDF = window.jspdf.jsPDF;

    const robotoFontBase64 = 'AAEAAAATAQAABAAwRFNJRwAAAAAAAAEAAAAVAAAAHEdERUYAAADgAAAAIAAAACBPUy8yAAABHAAAABgAAAAkY21hcAAAAVgAAAEeAAABYmdseWYAAAHoAAABMAAAADZnbHlmAAACcAAAAPQAAAFQaGVhZAAAAtkAAAE8AAAANmhoZWQAAALwAAAAMAAAACRobXR4AAADNAAAAEYAAAAYbG9jYQAABKAAAADQAAAAIG1heHAAABQIAAAABgAAAAgbmFtZQAABRgAAAE0AAABJnBvc3QAAAXEAAABNAAAAFV2ZXJzAAAGGAAAADUAAAAkZ1hZWiAAAAYAAAABAAAAAQAEAAMAAAABAAYAAwAEAAQAAQAAAAAAAAABAgAAAAEAAgACAAAAEgAAAAAAAAAAAAAAAAAAAAUAAAAAAAAAAAAAAAD8zw==';

    jsPDF.API.events.push([
      'addFonts',
      function () {
        this.addFileToVFS('Roboto-Regular.ttf', robotoFontBase64);
        this.addFont('Roboto-Regular.ttf', 'Roboto', 'normal');
      }
    ]);
  </script>
</head>

<body>
  <!-- HEADER -->
  <header class="page-title">
    <h1>Fritsch Group Chemical Inventory</h1>
  </header>

  <!-- MAIN ACTIONS -->
  <div class="home-container" id="home-section">
    <h2>Hello! What would you like to do?</h2>
    <div>
      <button onclick="generateLabels()">üè∑Ô∏è Generate Labels</button>
      <input type="file" id="excel-file" accept=".xlsx" onchange="handleFileUpload(event)" />
    </div>
    <div id="excel-preview" style="margin-top: 20px;"></div>
  </div>

  <script>
    let workingData = [];

    const robotoFontName = "Roboto";

    // Load Excel
    function handleFileUpload(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function (e) {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: "array" });
        const sheet = workbook.Sheets[workbook.SheetNames[0]];
        const json = XLSX.utils.sheet_to_json(sheet);

        workingData = json.map(item => ({
          ...item,
          Barcode: item["Barcode"] || generateRandomBarcode()
        }));

        displayExcelPreview(workingData);
      };
      reader.readAsArrayBuffer(file);
    }

    function displayExcelPreview(data) {
      const preview = document.getElementById("excel-preview");
      preview.innerHTML = "";
      if (data.length === 0) return;

      const table = document.createElement("table");
      const thead = document.createElement("thead");
      const headRow = document.createElement("tr");

      const selectHeader = document.createElement("th");
      selectHeader.textContent = "Select";
      headRow.appendChild(selectHeader);

      Object.keys(data[0]).forEach(key => {
        const th = document.createElement("th");
        th.textContent = key;
        headRow.appendChild(th);
      });

      thead.appendChild(headRow);
      table.appendChild(thead);

      const tbody = document.createElement("tbody");
      data.forEach((row, index) => {
        const tr = document.createElement("tr");

        const checkboxCell = document.createElement("td");
        const checkbox = document.createElement("input");
        checkbox.type = "checkbox";
        checkbox.className = "label-checkbox";
        checkbox.dataset.index = index;
        checkboxCell.appendChild(checkbox);
        tr.appendChild(checkboxCell);

        Object.values(row).forEach(val => {
          const td = document.createElement("td");
          td.textContent = val || "";
          tr.appendChild(td);
        });

        tbody.appendChild(tr);
      });

      table.appendChild(tbody);
      preview.appendChild(table);
    }

    function generateRandomBarcode() {
      return Math.floor(1000000000000000 + Math.random() * 9e15).toString();
    }

    function wrapText(doc, text, maxWidth, maxCharsPerLine = 30) {
      const words = text.split(" ");
      const lines = [];
      let currentLine = "";

      for (let i = 0; i < words.length; i++) {
        let word = words[i].trim();
        let testLine = currentLine ? currentLine + " " + word : word;

        if (doc.getTextWidth(testLine) < maxWidth && testLine.length <= maxCharsPerLine) {
          currentLine = testLine;
        } else {
          if (currentLine) lines.push(currentLine);
          while (word.length > 0) {
            let cutoff = Math.min(word.length, maxCharsPerLine);
            while (cutoff > 0 && doc.getTextWidth(word.slice(0, cutoff)) > maxWidth) {
              cutoff--;
            }
            if (cutoff === 0) break;
            lines.push(word.slice(0, cutoff));
            word = word.slice(cutoff);
          }
          currentLine = word;
        }
      }
      if (currentLine) lines.push(currentLine);
      return lines;
    }

    async function generateLabels() {
      const selectedIndexes = Array.from(document.querySelectorAll(".label-checkbox"))
        .filter(cb => cb.checked)
        .map(cb => parseInt(cb.dataset.index));

      const labelData = selectedIndexes.map(i => workingData[i]);

      if (labelData.length === 0) {
        alert("Please select at least one chemical to generate labels.");
        return;
      }

      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ unit: "mm", format: "letter" });

      doc.addFileToVFS("Roboto-Regular.ttf", robotoFontBase64);
      doc.addFont("Roboto-Regular.ttf", "Roboto", "normal");
      doc.setFont("Roboto", "normal");

      const labelWidth = 66.675;
      const labelHeight = 25.4;
      const spacingX = 4.175;
      const spacingY = 0.2;
      const marginX = 3.8;
      const marginY = 12.3;

      for (let i = 0; i < labelData.length; i++) {
        const item = labelData[i];
        const row = Math.floor((i % 30) / 3);
        const col = i % 3;
        const x = marginX + col * (labelWidth + spacingX);
        const y = marginY + row * (labelHeight + spacingY);

        // Create barcode
        const barcodeSvg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
        JsBarcode(barcodeSvg, item["Barcode"], {
          format: "CODE128",
          displayValue: false,
          height: 10,
          width: 1.5,
          margin: 0
        });

        const canvas = document.createElement("canvas");
        const svgBlob = new Blob([new XMLSerializer().serializeToString(barcodeSvg)], { type: "image/svg+xml" });
        const url = URL.createObjectURL(svgBlob);

        const img = new Image();
        await new Promise(resolve => {
          img.onload = () => {
            const ctx = canvas.getContext("2d");
            canvas.width = img.width;
            canvas.height = img.height;
            ctx.drawImage(img, 0, 0);
            URL.revokeObjectURL(url);
            resolve();
          };
          img.src = url;
        });

        const barcodeDataUrl = canvas.toDataURL("image/png");

        // Draw name
        const nameTop = y + 4;
        const nameLineHeight = 4;
        let fontSize = 9;
        doc.setFontSize(fontSize);

        let nameLines = wrapText(doc, item["Chemical Name"], labelWidth);
        while (nameLines.length > 2 && fontSize > 6) {
          fontSize -= 0.5;
          doc.setFontSize(fontSize);
          nameLines = wrapText(doc, item["Chemical Name"], labelWidth);
        }

        nameLines.slice(0, 2).forEach((line, idx) => {
          const yOffset = nameTop + idx * nameLineHeight;
          const xOffset = x + (labelWidth - doc.getTextWidth(line)) / 2;
          doc.text(line, xOffset, yOffset);
        });

        // CAS
        const cas = `CAS: ${item["CAS Number"] || "N/A"}`;
        doc.setFontSize(7);
        const casYOffset = nameTop + nameLines.length * nameLineHeight + 1.5;
        doc.text(cas, x + (labelWidth - doc.getTextWidth(cas)) / 2, casYOffset);

        // Barcode image
        const barcodeYOffset = casYOffset + 2;
        doc.addImage(
          barcodeDataUrl,
          "PNG",
          x + (labelWidth - 40) / 2,
          barcodeYOffset,
          40,
          5
        );

        // Barcode number
        const barcodeText = item["Barcode"];
        doc.setFontSize(8);
        doc.text(barcodeText, x + (labelWidth - doc.getTextWidth(barcodeText)) / 2, barcodeYOffset + 8.5);

        if ((i + 1) % 30 === 0 && i + 1 < labelData.length) {
          doc.addPage();
        }
      }

      const today = new Date().toISOString().slice(0, 10);
      doc.save(`Chemical_Labels_${today}.pdf`);
    }
  </script>
</body>
</html>
